# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 프로젝트 개요

상속세 계산 솔루션 프로그램. 사용자가 질문에 답하는 방식으로 정보를 입력하면, 여러 케이스별로 상속세를 계산하여 가장 절세 효과가 높은 방법을 제시한다.

## 기술 스택

- **언어**: Python 3.x
- **UI**: Streamlit (데스크톱/웹 겸용)
- **향후 확장**: 웹 서비스 배포 예정

## Build & Development Commands

```bash
# 가상환경 생성 및 활성화
python -m venv venv
venv\Scripts\activate  # Windows

# 의존성 설치
pip install -r requirements.txt

# 앱 실행
streamlit run app.py

# 테스트 실행
pytest
pytest tests/test_calculator.py -v  # 단일 테스트 파일
```

## Architecture

```
sangsok/
├── app.py                 # Streamlit 메인 앱 (대화형 UI)
├── calculator/
│   ├── __init__.py
│   ├── inheritance_tax.py # 상속세 계산 핵심 로직
│   ├── deductions.py      # 공제 항목 계산
│   └── cases.py           # 케이스별 시나리오 비교 로직
├── models/
│   ├── __init__.py
│   └── asset.py           # 자산/상속인 데이터 모델
├── tests/
│   └── test_calculator.py
└── requirements.txt
```

---

## 구현 상세 (Implementation Details)

### app.py - 메인 애플리케이션 (약 1900줄)

#### 핵심 구성요소

| 라인 범위 | 함수/상수 | 설명 |
|-----------|-----------|------|
| 32-242 | `parse_with_llm()` | Gemini API로 자연어 파싱 (자산, 배우자, 자녀, 채무 등) |
| 249-323 | 유틸리티 함수들 | `format_currency()`, `get_tax_rate_info()`, `get_legal_inheritance_shares()` |
| 325-550 | 폴백 파서들 | LLM 없이도 작동하는 정규식 기반 파서들 |
| 552-568 | `STEPS` | 대화 단계 정의 (15단계) |
| 571-648 | `get_step_question()` | 각 단계별 질문 텍스트 |
| 650-773 | `get_data_summary()` | 입력 데이터 요약 표시 |
| 782-1358 | `process_input()` | 사용자 입력 처리 (핵심 로직) |
| 1360-1429 | 네비게이션 함수들 | `go_back()`, `jump_to_step()`, `clear_step_data()` |
| 1431-1490 | `build_inheritance_info()` | 입력 데이터 → InheritanceInfo 변환 |
| 1492-1797 | `show_result()` | 결과 화면 표시 (3단계 계산 과정) |
| 1799-1900+ | `main()` | 앱 진입점, 세션 상태 초기화, 사이드바 |

#### 대화 단계 (STEPS)

```python
STEPS = [
    "assets",           # 0: 상속재산
    "real_estate_debt", # 1: 부동산 채무 (보증금, 대출)
    "spouse",           # 2: 배우자 유무
    "spouse_detail",    # 3: 배우자 상세
    "children",         # 4: 자녀 유무/수
    "children_detail",  # 5: 자녀 상세
    "grandchild",       # 6: 세대생략 여부
    "grandchild_detail",# 7: 세대생략 상세
    "funeral_costs",    # 8: 장례비용
    "other_debts",      # 9: 기타 채무
    "prior_gift",       # 10: 사전증여 유무
    "prior_gift_detail",# 11: 사전증여 상세
    "co_residence",     # 12: 동거주택공제
    "confirm",          # 13: 최종 확인
    "result"            # 14: 결과
]
```

#### 세션 상태 (st.session_state)

| 키 | 타입 | 설명 |
|----|------|------|
| `step` | int | 현재 대화 단계 (0-14) |
| `messages` | list | 대화 기록 `[{"role": "user/assistant", "content": "..."}]` |
| `data` | dict | 수집된 모든 입력 데이터 |
| `step_history` | list | 방문한 단계 기록 (뒤로가기용) |

#### data 딕셔너리 구조

```python
data = {
    # 자산
    "assets": {"real_estate": int, "financial": int, "cash": int, ...},

    # 부동산 채무
    "real_estate_debt": {"deposit": int, "loan": int},

    # 배우자
    "has_spouse": bool,
    "spouse_age": int,
    "spouse_disabled": bool,
    "spouse_life_expectancy": int,

    # 자녀
    "has_children": bool,
    "num_children": int,
    "children": [{"age": int, "disabled": bool}, ...],

    # 세대생략
    "has_grandchild": bool,
    "grandchild_amount": int,
    "grandchild_age": int,

    # 장례비용
    "debts": {"funeral_expense": int, "funeral_memorial": int},

    # 기타 채무
    "other_debts": {"public_charges": int, "debt": int},

    # 사전증여
    "has_prior_gift": bool,
    "prior_gift": {"to_heir_10yr": int, "to_heir_10yr_tax": int},

    # 동거주택
    "co_residence_eligible": bool,

    # 기한내 신고
    "file_on_time": bool
}
```

---

### calculator/inheritance_tax.py - 상속세 계산

| 구성요소 | 설명 |
|----------|------|
| `TAX_BRACKETS` | 세율 구간 상수 (1억이하 10% ~ 30억초과 50%) |
| `calculate_tax_amount()` | 과세표준 → 산출세액 계산 |
| `calculate_generation_skip_surcharge()` | 세대생략 할증 계산 (30%/40%) |
| `calculate_filing_credit()` | 신고세액공제 (3%) |
| `TaxResult` | 계산 결과 데이터클래스 |
| `calculate_inheritance_tax()` | **메인 함수**: 전체 상속세 계산 |

---

### calculator/deductions.py - 공제 계산

| 구성요소 | 설명 |
|----------|------|
| 상수들 | `LUMP_SUM_DEDUCTION=5억`, `SPOUSE_MAX_DEDUCTION=30억` 등 |
| `DeductionType` | 일괄공제 vs 항목별공제 enum |
| `calculate_spouse_deduction()` | 배우자공제 (5억~30억) |
| `calculate_financial_deduction()` | 금융재산공제 (2천만~2억) |
| `calculate_co_residence_deduction()` | 동거주택공제 (최대 6억) |
| `calculate_deductions()` | **메인 함수**: 전체 공제액 계산 |

---

### calculator/cases.py - 케이스 비교

| 구성요소 | 설명 |
|----------|------|
| `CaseResult` | 케이스별 결과 데이터클래스 |
| `ComparisonResult` | 비교 결과 (모든 케이스 + 최적 케이스) |
| `generate_cases()` | 비교할 케이스 목록 생성 |
| `compare_cases()` | **메인 함수**: 케이스별 세액 비교 |

케이스 종류 (배우자 있는 경우):
- A: 법정상속분 - 배우자가 법정비율대로 상속
- B: 배우자 최대 - 배우자 상속 최대화 (30억 한도)
- C: 배우자 최소 - 배우자 상속 최소화 (5억)

---

### models/asset.py - 데이터 모델

| 클래스 | 설명 |
|--------|------|
| `Asset` | 자산 정보 (부동산, 금융, 현금 등) |
| `ChildInfo` | 자녀 정보 (나이, 장애여부, 손자녀여부) |
| `SpouseInfo` | 배우자 정보 |
| `Heir` | 상속인 전체 정보 |
| `Deductions` | 채무/장례비용 공제 |
| `PriorGift` | 사전증여 정보 |
| `CoResidenceInfo` | 동거주택공제 정보 |
| `InheritanceInfo` | **최상위 모델**: 모든 상속 정보 통합 |

---

## UI/UX 구조

### 화면 레이아웃

```
┌─────────────────────────────────────────────────────────┐
│  🏛️ 상속세 계산기                           [사이드바] │
├─────────────────────────────────────────────────────────┤
│  [대화 기록 - 스크롤 가능]                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 🤖 상속재산을 알려주세요...                      │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 👤 아파트 15억, 예금 2억                         │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  [버튼: 예/아니오] 또는 [텍스트 입력창]                 │
│  [← 이전 단계] [처음부터 다시]                          │
└─────────────────────────────────────────────────────────┘
```

### 사이드바 (개발자 도구)

- **디자인 테스트**: 테스트 데이터로 결과 화면 바로 보기
- **처음으로 리셋**: 세션 초기화

### 결과 화면 구조

```
1단계: 과세가액 = 총 상속재산 - 채무/비용 + 사전증여
       ├── 총 상속재산 (부동산, 금융, 현금 등)
       ├── (-) 채무/비용 (보증금, 대출, 장례비)
       └── (+) 사전증여

2단계: 과세표준 = 과세가액 - 공제
       ├── 과세가액
       └── (-) 공제 (일괄/배우자/금융재산)

3단계: 최종 세액
       ├── 산출세액 (세율표 적용)
       ├── (+) 세대생략 할증
       ├── (-) 신고세액공제 3%
       └── (-) 기납부 증여세

[케이스별 비교표: A/B/C 케이스 세액 비교]
```

---

## 변경 이력

| 날짜 | 변경 내용 |
|------|-----------|
| 2024-12 | 초기 버전: 대화형 UI로 전환 |
| 2024-12 | Gemini API 연동 (자연어 파싱) |
| 2024-12 | 케이스별 비교 기능 추가 |
| 2024-12 | 개발자 도구 (디자인 테스트) 추가 |
| 2024-12 | 금융재산공제에 보험금(insurance) 포함 |
| 2024-12 | 금융재산공제 계산 시 부동산 채무 차감 제거 |
| 2024-12 | LLM 프롬프트 개선: 줄임말/은어 자동 추론 기능 추가 |

---

## 상속세 계산 규칙 (상세)

### 1. 총 상속재산가액

다음 항목들의 합계:
- 부동산
- 유가증권
- 현금
- 보험금 (계약자와 피보험자가 피상속인인 경우)
- 퇴직금
- 신탁재산

### 2. 공과금 / 장례비용 / 채무 공제

#### 2.1 공과금
- 상속인에게 승계된 조세/공공요금

#### 2.2 장례비용
- 500만원 미만인 경우: **500만원** 공제 (최소)
- 1,000만원 초과하는 경우: **1,000만원** 까지만 공제 (최대)
- 봉안시설 등 사용금액: 별도로 **500만원** 한도 추가 공제

#### 2.3 채무
- 채무 합계액이 상속재산가액 초과 시, 초과액은 없는 것으로 봄

### 3. 사전증여 재산 (과세가액 가산)

| 대상 | 기간 |
|------|------|
| 상속인에게 증여 | 10년 이내 |
| 상속인 아닌 자에게 증여 | 5년 이내 |
| 창업자금/가업승계 주식 | 기간 무관 (전액 가산) |

- 증여재산가액은 **증여일 기준** 평가 가액 사용

### 4. 상속공제

#### 4.1 일괄공제
```
max(기초공제 2억 + 그밖의 인적공제, 5억)
```

#### 4.2 기초공제
- **2억원**

#### 4.3 배우자공제

| 상황 | 공제액 |
|------|--------|
| 실제 상속액 없거나 5억 미만 | **5억원** |
| 상속액 5억 이상 | min(30억, 과세가액 중 배우자 법정지분 - 배우자 사전증여 과세표준) |

- 주의: 상속세 신고기한 다음날부터 6개월 내 배우자 상속재산 분할(등기) 필요

#### 4.4 인적공제

| 항목 | 공제액 | 중복 가능 |
|------|--------|-----------|
| 자녀 | 1인당 **5천만원** | 미성년자와 중복 O |
| 미성년자 | (19세 - 현재나이) × **1천만원** | 자녀와 중복 O |
| 연로자 (65세 이상) | 1인당 **5천만원** | |
| 장애인 | 기대여명 × **1천만원** | 모든 공제와 중복 O |

- **배우자는 자녀/미성년자/연로자 공제와 중복 불가**

#### 4.5 금융재산공제

| 순금융재산 | 공제액 |
|------------|--------|
| 2천만원 미만 | **전액** |
| 2천만원 ~ 1억 | **2천만원** |
| 1억 초과 | 순금융재산의 **20%** (최대 2억) |

#### 4.6 동거주택 상속공제

- 공제 한도: **6억원**
- 요건:
  1. 피상속인이 거주자일 것
  2. 피상속인과 상속인(직계비속)이 10년 이상 계속 동거
  3. 10년 이상 1세대 1주택 소유
  4. 상속인이 상속개시일 현재 무주택자

- 1세대 1주택 예외:
  - 일시적 2주택
  - 혼인 합가
  - 등록문화재 주택
  - 이농·귀농 주택
  - 직계존속 동거봉양

### 5. 세대생략 할증

| 상황 | 할증률 |
|------|--------|
| 자녀가 아닌 직계비속 (손자녀 등) | **30%** |
| 미성년자가 20억 초과 상속 | **40%** |

- 예외: 직계비속 사망으로 최근친 직계비속인 경우 할증 없음

### 6. 상속세율

| 과세표준 | 세율 | 누진공제 |
|----------|------|----------|
| 1억 이하 | 10% | - |
| 5억 이하 | 20% | 1천만원 |
| 10억 이하 | 30% | 6천만원 |
| 30억 이하 | 40% | 1억 6천만원 |
| 30억 초과 | 50% | 4억 6천만원 |

### 7. 세액공제

- **신고세액공제**: 산출세액의 3% (기한 내 신고 시)
- **기납부 증여세액 공제**: 사전증여 시 납부한 증여세

---

## 케이스 비교 전략

다음 변수에 따라 여러 케이스를 비교하여 최적 절세안 제시:
- 배우자 상속 비율 (법정지분 vs 최대공제)
- 일괄공제 vs 개별공제 (자녀 수에 따라 유불리)
- 동거주택공제 적용 여부
- 금융재산공제 적용
